# CI for building GammaRay (Linux + Windows). Triggers on workflow_dispatch and tag pushes (v*).
on:
  workflow_dispatch:
  push:
    tags:
      - "v*"

name: Build GammaRay (Linux + Windows)

permissions:
  contents: write

env:
  GR_PROJECT_PATH: ${{ github.workspace }}

jobs:
  build:
    name: Build (${{ matrix.os }})
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        os: [ubuntu-latest, windows-latest]
        build_type: [Release]
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          submodules: recursive
          token: ${{ secrets.GITHUB_TOKEN }}
          set-safe-directory: true
      
      - name: Fix Submodule URLs
        shell: bash
        run: |
          # Convert SSH URLs to HTTPS for submodules that don't have access
          
          echo "Current directory: $(pwd)"
          echo "Listing .gitmodules files:"
          find . -name ".gitmodules" -type f
          
          # Fix root submodules first
          if [ -f ".gitmodules" ]; then
            echo "Fixing root submodule URLs"
            # Convert SSH URLs to HTTPS if any exist
            if [[ "$RUNNER_OS" == "Linux" ]]; then
              sed -i 's|git@github.com:|https://github.com/|g' .gitmodules
            else
              # Windows sed syntax
              sed -i 's|git@github.com:|https://github.com/|g' .gitmodules
            fi
            echo "Updated .gitmodules content:"
            cat .gitmodules
            # Sync all submodules - use the correct syntax
            git submodule sync || echo "git submodule sync failed, continuing..."
            # Re-initialize and update submodules that may have failed
            git submodule update --init --recursive --no-single-branch --force || echo "Some submodules may have failed to update, will handle in next step"
          else
            echo "No .gitmodules found in root"
          fi
          
          # Handle tc_3rdparty specifically if it exists and has its own submodules
          if [ -d "deps/tc_3rdparty" ] && [ -d "deps/tc_3rdparty/.git" ]; then
            echo "tc_3rdparty exists and is a git repository"
            cd deps/tc_3rdparty
            if [ -f ".gitmodules" ]; then
              echo "Fixing submodule URLs in tc_3rdparty"
              echo "Current tc_3rdparty .gitmodules content:"
              cat .gitmodules
              # Convert SSH URLs to HTTPS if any exist
              if [[ "$RUNNER_OS" == "Linux" ]]; then
                sed -i 's|git@github.com:|https://github.com/|g' .gitmodules
              else
                # Windows sed syntax
                sed -i 's|git@github.com:|https://github.com/|g' .gitmodules
              fi
              echo "Updated tc_3rdparty .gitmodules content:"
              cat .gitmodules
              # Sync all submodules - use the correct syntax
              git submodule sync || echo "git submodule sync in tc_3rdparty failed, continuing..."
              # Initialize and update submodules
              git submodule update --init --recursive --no-single-branch --force || echo "Some tc_3rdparty submodules may have failed to update"
            else
              echo "No .gitmodules found in tc_3rdparty"
            fi
            cd ../..
          else
            echo "Directory deps/tc_3rdparty does not exist or is not a git repository"
          fi

      - name: Setup common tools (cmake, ninja, python)
        if: runner.os == 'Linux'
        run: |
          sudo apt-get update
          sudo apt-get install -y build-essential cmake ninja-build pkg-config python3 python3-pip git
      - name: Setup CMake
        if: runner.os == 'Windows'
        uses: jwlawson/actions-setup-cmake@v2.0
        with:
          cmake-version: '4.x'
      
      - name: Setup Ninja
        if: runner.os == 'Windows'
        uses: seanmiddleditch/gha-setup-ninja@master
      
      - name: Setup Python
        if: runner.os == 'Windows'
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'
      
      - name: Verify Python installation
        if: runner.os == 'Windows'
        shell: powershell
        run: |
          # Verify Python is properly set up and accessible
          python --version
          python -m pip --version
          # Set explicit Python path to avoid WindowsApps issues
          $pythonPath = (Get-Command python).Source
          echo "Python path: $pythonPath"
          echo "PYTHON_PATH=$pythonPath" | Out-File -FilePath $env:GITHUB_ENV -Encoding utf8 -Append
          # Remove WindowsApps Python alias to avoid EACCES errors
          if ($pythonPath -like "*WindowsApps*") {
            echo "WindowsApps Python detected, using hostedtoolcache Python instead"
            $hostedPython = "C:\hostedtoolcache\windows\Python\3.12.10\x64\python.exe"
            if (Test-Path $hostedPython) {
              echo "PYTHON_PATH=$hostedPython" | Out-File -FilePath $env:GITHUB_ENV -Encoding utf8 -Append
              echo "Using hostedtoolcache Python: $hostedPython"
            }
          }
          # Install aqtinstall with explicit Python path
          $pythonExe = $env:PYTHON_PATH
          & $pythonExe -m pip install --upgrade pip
          & $pythonExe -m pip install aqtinstall

      - name: Install system deps (Linux)
        if: runner.os == 'Linux'
        run: |
          sudo apt-get update
          sudo apt-get install -y libssl-dev libx11-dev libgl1-mesa-dev libglu1-mesa-dev libxcb-xinerama0-dev
          sudo apt-get install -y libasound2-dev libpulse-dev libxss1 libxcursor1 libxi6 libxtst6
          sudo apt-get install -y libavcodec-dev libavformat-dev libswscale-dev libavutil-dev
          sudo apt-get install -y libopencv-dev libglm-dev libfftw3-dev
          # Install Qt6 system packages
          sudo apt-get install -y qt6-base-dev qt6-tools-dev qt6-charts-dev qt6-svg-dev qt6-5compat-dev
          # Install additional system dependencies
          sudo apt-get install -y libsdl2-dev libxkbcommon-dev libxkbcommon-x11-dev
          sudo apt-get install -y libgflags-dev libgtest-dev libvpx-dev libprotobuf-dev protobuf-compiler
          # Install autotools dependencies required by vcpkg packages (e.g., gperf, libxcrypt)
          sudo apt-get install -y autoconf autoconf-archive automake libtool libltdl-dev
          # Install additional system dependencies required by libsystemd
           sudo apt-get install -y libcap-dev libmount-dev libpam0g-dev libselinux1-dev libudev-dev
           sudo apt-get install -y pkg-config python3-dev liblz4-dev liblzma-dev libzstd-dev
           # Install Vulkan development packages
           sudo apt-get install -y libvulkan-dev vulkan-tools
          # add other -dev packages as needed (e.g. libasound2-dev, libpulse-dev) depending on CMake errors

      - name: Ensure Submodules are Complete
        shell: bash
        run: |
          # Ensure all critical submodules are available
          cd deps
          
          # List of required submodules that might be missing
          REQUIRED_SUBMODULES="tc_3rdparty tc_account_sdk tc_message_new tc_qt_widget tc_relay_client tc_spvr_client tc_steam_manager_new tc_controller tc_webrtc_client tc_common_new tc_encoder_new tc_opus_codec_new"
          
          for submodule in $REQUIRED_SUBMODULES; do
            if [ ! -d "$submodule/CMakeLists.txt" ] || [ -z "$(ls -A $submodule)" ]; then
              echo "Submodule $submodule is incomplete or empty, attempting to clone..."
              rm -rf "$submodule"
              # Try HTTPS clone first, then fallback to creating empty directory
              if git clone "https://github.com/RGAA-Software/$submodule.git" "$submodule" 2>/dev/null; then
                echo "Successfully cloned $submodule"
              elif git clone "https://github.com/microsoft/$submodule.git" "$submodule" 2>/dev/null; then
                echo "Successfully cloned $submodule from Microsoft"
              elif git clone "https://github.com/google/$submodule.git" "$submodule" 2>/dev/null; then
                echo "Successfully cloned $submodule from Google"
              elif git clone "https://github.com/xiph/$submodule.git" "$submodule" 2>/dev/null; then
                echo "Successfully cloned $submodule from Xiph"
              else
                echo "Failed to clone $submodule, creating empty directory"
                mkdir -p "$submodule"
                echo "# Empty placeholder for $submodule" > "$submodule/CMakeLists.txt"
              fi
            else
              echo "Submodule $submodule is OK"
            fi
          done
          
          # Handle tc_3rdparty internal submodules
          if [ -d "tc_3rdparty" ]; then
            cd tc_3rdparty
            INTERNAL_SUBMODULES="leveldb opus"
            for submodule in $INTERNAL_SUBMODULES; do
              if [ ! -d "$submodule/CMakeLists.txt" ] || [ -z "$(ls -A $submodule)" ]; then
                echo "Internal submodule $submodule is incomplete, attempting to clone..."
                rm -rf "$submodule"
                if [ "$submodule" = "leveldb" ]; then
                  git clone "https://github.com/google/$submodule.git" "$submodule"
                elif [ "$submodule" = "opus" ]; then
                  git clone "https://github.com/xiph/$submodule.git" "$submodule"
                fi
              fi
            done
            cd ..
          fi

      - name: Configure Qt installation environment
        shell: bash
        run: |
          # Set environment variables to handle network timeouts
          echo "AQT_CONFIG=mirrors=mirrors.ocf.berkeley.edu,ftp.fau.de,download.qt.io" >> $GITHUB_ENV
          echo "AQT_TIMEOUT=300" >> $GITHUB_ENV
          echo "AQT_RETRIES=3" >> $GITHUB_ENV
          # Increase timeout for network operations
          echo "VCPKG_MAX_CONCURRENCY=4" >> $GITHUB_ENV
          # Handle Windows-specific Python issues
          if [ "${{ runner.os }}" = "Windows" ]; then
            echo "PYTHONIOENCODING=utf-8" >> $GITHUB_ENV
            echo "PYTHONUTF8=1" >> $GITHUB_ENV
            # Disable WindowsApps store to avoid permission issues
            echo "PYTHONDONTWRITEBYTECODE=1" >> $GITHUB_ENV
          fi

      - name: Setup Qt6 (Linux)
        if: runner.os == 'Linux'
        timeout-minutes: 20
        uses: jurplel/install-qt-action@v4
        with:
          version: '6.6.2'
          host: 'linux'
          target: 'desktop'
          cache: true
          install-deps: false
          mirror: 'https://mirrors.ocf.berkeley.edu/qt/'
          extra: '--external 7z'
        continue-on-error: true
      
      - name: Setup Qt6 (Linux - Fallback)
        if: runner.os == 'Linux' && failure()
        timeout-minutes: 20
        uses: jurplel/install-qt-action@v4
        with:
          version: '6.6.2'
          host: 'linux'
          target: 'desktop'
          cache: true
          install-deps: false
          mirror: 'https://ftp.fau.de/qtproject/'
          extra: '--external 7z'
        continue-on-error: true
      
      - name: Setup Qt6 (Linux - Final Fallback)
        if: runner.os == 'Linux' && failure()
        timeout-minutes: 20
        uses: jurplel/install-qt-action@v4
        with:
          version: '6.6.2'
          host: 'linux'
          target: 'desktop'
          cache: true
          install-deps: false
          extra: '--external 7z'
      
      - name: Setup Qt6 (Windows)
        if: runner.os == 'Windows'
        timeout-minutes: 20
        uses: jurplel/install-qt-action@v4
        with:
          version: '6.6.2'
          host: 'windows'
          target: 'desktop'
          cache: true
          install-deps: false
          mirror: 'https://mirrors.ocf.berkeley.edu/qt/'
          extra: '--external 7z'
        continue-on-error: true
      
      - name: Setup Qt6 (Windows - Fallback)
        if: runner.os == 'Windows' && failure()
        timeout-minutes: 20
        uses: jurplel/install-qt-action@v4
        with:
          version: '6.6.2'
          host: 'windows'
          target: 'desktop'
          cache: true
          install-deps: false
          mirror: 'https://ftp.fau.de/qtproject/'
          extra: '--external 7z'
        continue-on-error: true
      
      - name: Setup Qt6 (Windows - Final Fallback)
        if: runner.os == 'Windows' && failure()
        timeout-minutes: 20
        uses: jurplel/install-qt-action@v4
        with:
          version: '6.6.2'
          host: 'windows'
          target: 'desktop'
          cache: true
          install-deps: false
          extra: '--external 7z'

      - name: Install vcpkg (Windows)
        if: runner.os == 'Windows'
        shell: powershell
        timeout-minutes: 30
        run: |
          # clone vcpkg into the path expected by your CMakeLists (matches the error path)
          git clone --depth=1 https://github.com/microsoft/vcpkg.git C:/source/vcpkg
          C:/source/vcpkg/bootstrap-vcpkg.bat
          # optional: integrate (not strictly required for CMake toolchain usage)
          try { C:/source/vcpkg/vcpkg.exe integrate install } catch { }
          echo "VCPKG_ROOT=C:/source/vcpkg" | Out-File -FilePath $env:GITHUB_ENV -Encoding utf8 -Append
          # Set vcpkg environment variables for better network handling
          echo "VCPKG_BINARY_SOURCES=clear;x-gha,readwrite" | Out-File -FilePath $env:GITHUB_ENV -Encoding utf8 -Append
          # Install required packages (qtwayland is not supported on Windows)
          # Install packages with retry logic
          $packages = @("qtbase", "qttools", "qtcharts", "qtsvg", "qtwebsockets", "qt5compat", "gflags", "sdl2", "fftw3", "openssl", "cpr", "opencv", "protobuf", "glm", "libvpx")
          foreach ($pkg in $packages) {
            Write-Host "Installing $pkg..."
            $retryCount = 0
            $maxRetries = 3
            while ($retryCount -lt $maxRetries) {
              try {
                C:/source/vcpkg/vcpkg.exe install $pkg --triplet=x64-windows --retry=3
                break
              } catch {
                $retryCount++
                Write-Host "Failed to install $pkg (attempt $retryCount/$maxRetries), retrying..."
                if ($retryCount -eq $maxRetries) {
                  Write-Host "Failed to install $pkg after $maxRetries attempts, continuing..."
                }
              }
            }
          }

      - name: Install vcpkg (Linux)
        if: runner.os == 'Linux'
        timeout-minutes: 30
        run: |
          # Install vcpkg in user home directory
          git clone --depth=1 https://github.com/microsoft/vcpkg.git $HOME/vcpkg
          $HOME/vcpkg/bootstrap-vcpkg.sh
          # Set environment variable for subsequent steps
          echo "VCPKG_ROOT=$HOME/vcpkg" >> $GITHUB_ENV
          # Set environment variables to help with libsystemd build
          echo "VCPKG_FORCE_SYSTEM_BINARIES=1" >> $GITHUB_ENV
          echo "VCPKG_ALLOW_SYSTEM_LIBS=1" >> $GITHUB_ENV
          echo "MESON_CROSS_FILE=" >> $GITHUB_ENV
          echo "VCPKG_BINARY_SOURCES=clear;x-gha,readwrite" >> $GITHUB_ENV
          # Install system libsystemd development packages to avoid vcpkg building it
          sudo apt-get install -y libsystemd-dev libudev-dev
          # Create custom triplet to avoid libsystemd issues if needed
          mkdir -p $HOME/vcpkg/triplets
          cat > $HOME/vcpkg/triplets/x64-linux-custom.cmake << 'EOF'
          set(VCPKG_TARGET_ARCHITECTURE x64)
          set(VCPKG_CRT_LINKAGE dynamic)
          set(VCPKG_LIBRARY_LINKAGE dynamic)
          set(VCPKG_CMAKE_CONFIGURE_OPTIONS -DSYSTEMD=OFF)

          set(VCPKG_CXX_FLAGS "")
          set(VCPKG_C_FLAGS "")
          EOF
          # Check vcpkg version
          $HOME/vcpkg/vcpkg version
          # Install packages with retry logic
           PACKAGES="qtbase qttools qtcharts qtsvg qtwebsockets qt5compat qtwayland gflags sdl2 fftw3 openssl cpr opencv protobuf glm libvpx"
           for pkg in $PACKAGES; do
             echo "Installing $pkg..."
             retry_count=0
             max_retries=3
             while [ $retry_count -lt $max_retries ]; do
               if $HOME/vcpkg/vcpkg install $pkg --triplet=x64-linux --retry=3; then
                 echo "Successfully installed $pkg"
                 break
               else
                 retry_count=$((retry_count + 1))
                 echo "Failed to install $pkg (attempt $retry_count/$max_retries), retrying..."
                 if [ $retry_count -eq $max_retries ]; then
                   echo "Failed to install $pkg after $max_retries attempts, continuing..."
                 fi
               fi
             done
           done

      - name: Show info
        shell: bash
        run: |
          echo "OS: $RUNNER_OS"
          cmake --version || true
          ninja --version || true
          python3 --version || python --version || true
          if [ "${{ runner.os }}" = "Windows" ]; then where ninja || where cmake || where python || true; fi

      - name: Configure with CMake (Linux)
        if: runner.os == 'Linux'
        run: |
          mkdir -p build
          cmake -S . -B build -G Ninja \
            -DGR_PROJECT_PATH="${{ env.GR_PROJECT_PATH }}" \
            -DCMAKE_BUILD_TYPE=${{ matrix.build_type }} \
            -DCMAKE_EXPORT_COMPILE_COMMANDS=ON \
            -DCMAKE_TOOLCHAIN_FILE="${{ env.VCPKG_ROOT }}/scripts/buildsystems/vcpkg.cmake" \
            -DVCPKG_TARGET_TRIPLET="x64-linux"

      - name: Configure with CMake (Windows, using vcpkg + Ninja)
        if: runner.os == 'Windows'
        shell: powershell
        run: |
          mkdir build -ErrorAction SilentlyContinue
          cmake -S . -B build -G Ninja `
            -DGR_PROJECT_PATH="${{ env.GR_PROJECT_PATH }}" `
            -DCMAKE_BUILD_TYPE=${{ matrix.build_type }} `
            -DCMAKE_EXPORT_COMPILE_COMMANDS=ON `
            -DCMAKE_TOOLCHAIN_FILE="${{ env.VCPKG_ROOT }}/scripts/buildsystems/vcpkg.cmake" `
            -DVCPKG_TARGET_TRIPLET="x64-windows"

      # Alternative for Windows if you prefer Visual Studio generator (uncomment to use)
      # - name: Configure with CMake (Windows, Visual Studio generator)
      #   if: runner.os == 'Windows'
      #   shell: powershell
      #   run: |
      #     mkdir build -ErrorAction SilentlyContinue
      #     cmake -S . -B build -G "Visual Studio 17 2022" -A x64 `
      #       -DGR_PROJECT_PATH="${{ env.GR_PROJECT_PATH }}" `
      #       -DCMAKE_BUILD_TYPE=${{ matrix.build_type }} `
      #       -DCMAKE_EXPORT_COMPILE_COMMANDS=ON `
      #       -DCMAKE_TOOLCHAIN_FILE="${{ env.VCPKG_ROOT }}/scripts/buildsystems/vcpkg.cmake" `
      #       -DVCPKG_TARGET_TRIPLET="x64-windows"

      - name: Build
        shell: bash
        run: |
          cmake --build build --config ${{ matrix.build_type }} --parallel

      - name: Package artifacts
        shell: bash
        run: |
          mkdir -p artifacts
          if [ "${{ runner.os }}" = "Linux" ]; then
            # Pack build outputs (adjust paths if your actual binaries live elsewhere)
            if [ -d build/bin ]; then
              tar -czf artifacts/GammaRay-linux-${{ github.ref_name || 'manual' }}.tar.gz -C build bin || true
            else
              tar -czf artifacts/GammaRay-linux-${{ github.ref_name || 'manual' }}.tar.gz -C build . || true
            fi
            ls -la artifacts || true
          else
            powershell -Command "
              $OutDir = 'artifacts';
              if (!(Test-Path $OutDir)) { New-Item -ItemType Directory -Path $OutDir | Out-Null }
              $srcCandidates = @('build\\bin\\Release','build\\bin','build');
              foreach ($s in $srcCandidates) {
                if (Test-Path $s) {
                  Compress-Archive -Path (Join-Path $s '*') -DestinationPath (Join-Path $OutDir 'GammaRay-windows-${{ github.ref_name || 'manual' }}.zip') -Force
                  break
                }
              }
            "
            powershell -Command "Get-ChildItem artifacts -Recurse | Select-Object FullName,Length"
          fi

      - name: Upload build artifact
        uses: actions/upload-artifact@v4
        with:
          name: build-artifacts-${{ matrix.os }}
          path: artifacts/*

  release:
    name: Create Release and upload assets
    runs-on: ubuntu-latest
    needs: build
    steps:
      - name: Download all build artifacts
        uses: actions/download-artifact@v4
        with:
          path: downloaded_artifacts

      - name: List downloaded files
        shell: bash
        run: |
          echo "Downloaded artifacts:"
          ls -R downloaded_artifacts || true

      - name: Create GitHub Release and upload assets
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ github.ref_name }}
          name: Release ${{ github.ref_name }}
          files: downloaded_artifacts/**/*
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
