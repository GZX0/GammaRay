name: Windows QEMU Cross-Compile

on:
  push:
    branches: [ ci/windows-qemu-vcpkg-build ]
  workflow_dispatch:

jobs:
  build-windows-qemu:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        submodules: recursive
        
    - name: Set up QEMU
      uses: docker/setup-qemu-action@v3
      with:
        platforms: windows-amd64
        
    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3
      
    - name: Create Windows Dockerfile
      run: |
        cat > Dockerfile.windows << 'EOF'
        FROM mcr.microsoft.com/windows/servercore:ltsc2022
        
        SHELL ["powershell", "-Command", "$ErrorActionPreference = 'Stop'; $ProgressPreference = 'SilentlyContinue';"]
        
        WORKDIR C:/build
        
        RUN Set-ExecutionPolicy Bypass -Scope Process -Force; \
            [System.Net.ServicePointManager]::SecurityProtocol = [System.Net.ServicePointManager]::SecurityProtocol -bor 3072; \
            iex ((New-Object System.Net.WebClient).DownloadString('https://community.chocolatey.org/install.ps1'))
        
        RUN choco install -y git cmake visualstudio2022buildtools visualstudio2022workload-nativedesktop --no-progress
        
        RUN git clone https://github.com/Microsoft/vcpkg.git C:/vcpkg
        WORKDIR C:/vcpkg
        RUN .\bootstrap-vcpkg.bat
        RUN .\vcpkg.exe install gflags:x64-windows sqlite3:x64-windows detours:x64-windows gtest:x64-windows libvpx:x64-windows opus:x64-windows fftw3:x64-windows easyhook:x64-windows glm:x64-windows sdl2:x64-windows jemalloc:x64-windows protobuf:x64-windows asio:x64-windows openssl:x64-windows ffmpeg:x64-windows opencv:x64-windows cpr:x64-windows
        
        RUN choco install -y qt6 --version=6.8.3 --no-progress
        
        WORKDIR C:/build/GammaRay
        COPY . .
        
        RUN "set(VCPKG_ROOT C:/vcpkg)" | Out-File -FilePath "env_settings.cmake" -Encoding utf8
        RUN "set(QT_ROOT C:/Qt/6.8.3/msvc2022_64)" | Out-File -FilePath "env_settings.cmake" -Encoding utf8 -Append
        RUN "set(VK_SDK_ROOT C:/VulkanSDK/1.3.290.0)" | Out-File -FilePath "env_settings.cmake" -Encoding utf8 -Append
        
        RUN mkdir build
        WORKDIR C:/build/GammaRay/build
        RUN cmake .. -G "Visual Studio 17 2022" -A x64 -DCMAKE_BUILD_TYPE=Release -DCMAKE_TOOLCHAIN_FILE="C:/vcpkg/scripts/buildsystems/vcpkg.cmake" -DVCPKG_TARGET_TRIPLET=x64-windows -DBUILD_PREMIUM=OFF -DJEMALLOC_ENABLED=ON -DMEMORY_STST_ENABLED=OFF -DBUILD_FROM=CI
        
        RUN cmake --build . --config Release --parallel 4
        RUN cmake --install . --config Release --prefix C:/build/GammaRay/install
        
        FROM mcr.microsoft.com/windows/nanoserver:ltsc2022
        COPY --from=builder C:/build/GammaRay/install C:/gammaray
        WORKDIR C:/gammaray
        CMD ["cmd"]
        EOF
        
    - name: Build Windows image
      run: |
        docker buildx build \
          --platform windows/amd64 \
          --load \
          -f Dockerfile.windows \
          -t gammaray-windows-qemu \
          .
          
    - name: Extract artifacts
      run: |
        docker create --platform windows/amd64 --name temp-container gammaray-windows-qemu
        docker cp temp-container:C:/gammaray ./windows-build
        docker rm temp-container
        
    - name: Upload artifacts
      uses: actions/upload-artifact@v4
      with:
        name: gammaray-windows-qemu
        path: windows-build/
        retention-days: 7