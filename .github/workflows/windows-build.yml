name: Windows Build

on:
  push:
    branches: [ "main", "master" ]
  pull_request:

jobs:
  build:
    runs-on: windows-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install Qt
        uses: jurplel/install-qt-action@v3
        with:
          version: '6.6.3'
          host: 'windows'
          target: 'desktop'
          arch: 'win64_msvc2019_64'
          modules: 'qt5compat qtcharts qtsvg qtwebsockets'
          cache: true
          cache-key-prefix: install-qt-action
          install-deps: true
          add-tools-to-path: true
          set-env: true
          aqtversion: '==3.1.*'
          py7zrversion: '==0.20.*'
          setup-python: true

      - name: Export Qt root
        shell: pwsh
        run: |
          if (-not $env:Qt6_DIR) { throw 'Qt6_DIR was not set by install-qt-action.' }
          $qtRoot = $env:Qt6_DIR -replace '\\', '/'
          "QT_ROOT=$qtRoot" >> $env:GITHUB_ENV

      - name: Ensure vcpkg is present
        shell: pwsh
        run: |
          $vcpkgRoot = Join-Path $env:GITHUB_WORKSPACE 'deps/tc_3rdparty/vcpkg'
          if (-not (Test-Path $vcpkgRoot)) {
            git clone https://github.com/microsoft/vcpkg $vcpkgRoot
          }
          $vcpkgRootCMake = $vcpkgRoot -replace '\\', '/'
          $toolchainFile = Join-Path $vcpkgRoot 'scripts/buildsystems/vcpkg.cmake'
          $toolchainFileCMake = $toolchainFile -replace '\\', '/'
          "VCPKG_ROOT=$vcpkgRoot" >> $env:GITHUB_ENV
          "VCPKG_ROOT_CMAKE=$vcpkgRootCMake" >> $env:GITHUB_ENV
          "CMAKE_TOOLCHAIN_FILE=$toolchainFileCMake" >> $env:GITHUB_ENV

      - name: Cache vcpkg artifacts
        uses: actions/cache@v4
        with:
          path: |
            deps/tc_3rdparty/vcpkg/installed
            deps/tc_3rdparty/vcpkg/downloads
          key: ${{ runner.os }}-vcpkg-${{ hashFiles('docs/How_to_build.md') }}
          restore-keys: |
            ${{ runner.os }}-vcpkg-

      - name: Bootstrap vcpkg
        shell: pwsh
        run: |
          & "$env:VCPKG_ROOT/bootstrap-vcpkg.bat"

      - name: Install vcpkg dependencies
        shell: pwsh
        run: |
          $packages = @(
            'gflags:x64-windows',
            'sqlite3:x64-windows',
            'detours:x64-windows',
            'gtest:x64-windows',
            'libvpx:x64-windows',
            'opus:x64-windows',
            'fftw3:x64-windows',
            'easyhook:x64-windows',
            'glm:x64-windows',
            'sdl2:x64-windows',
            'jemalloc:x64-windows',
            'cpr:x64-windows',
            'mongo-cxx-driver:x64-windows',
            'drogon:x64-windows',
            'breakpad:x64-windows-static'
          )
          foreach ($package in $packages) {
            & "$env:VCPKG_ROOT/vcpkg.exe" install $package
          }

      - name: Configure CMake
        shell: pwsh
        run: |
          cmake -S . -B build -G "Visual Studio 17 2022" -A x64 `
            -DVCPKG_ROOT="$env:VCPKG_ROOT_CMAKE" `
            -DCMAKE_TOOLCHAIN_FILE="$env:CMAKE_TOOLCHAIN_FILE" `
            -DQT_ROOT="$env:QT_ROOT" `
            -DBUILD_FROM="CI" `
            -DCMAKE_BUILD_TYPE=Release

      - name: Build
        shell: pwsh
        run: cmake --build build --config Release -- /m
