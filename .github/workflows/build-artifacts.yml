name: Build Artifacts

on:
  push:
  pull_request:
  workflow_dispatch:

jobs:
  build-windows:
    name: Build (Windows)
    runs-on: windows-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          submodules: recursive
          fetch-depth: 0

      - name: Install Qt (6.5.3)
        uses: jurplel/install-qt-action@v3
        with:
          version: '6.5.3'
          host: 'windows'
          target: 'desktop'
          arch: 'win64_msvc2019_64'
          dir: 'C:/Qt'

      - name: Set QT_ROOT env
        shell: pwsh
        run: |
          $qtRoot = "C:/Qt/6.5.3/msvc2019_64"
          echo "QT_ROOT=$qtRoot" >> $env:GITHUB_ENV

      - name: Bootstrap vcpkg (local submodule)
        shell: pwsh
        run: |
          cd deps/tc_3rdparty/vcpkg
          .\bootstrap-vcpkg.bat

      - name: Install vcpkg dependencies
        shell: pwsh
        run: |
          $VCPKG_EXE = Resolve-Path "deps/tc_3rdparty/vcpkg/vcpkg.exe"
          & $VCPKG_EXE install gflags:x64-windows sqlite3:x64-windows detours:x64-windows gtest:x64-windows libvpx:x64-windows opus:x64-windows fftw3:x64-windows easyhook:x64-windows glm:x64-windows sdl2:x64-windows jemalloc:x64-windows

      - name: Configure CMake (Release)
        shell: pwsh
        run: |
          cmake -S . -B build -G "Visual Studio 17 2022" -DCMAKE_BUILD_TYPE=Release -DQT_ROOT="$env:QT_ROOT" -DVCPKG_ROOT="${{ github.workspace }}\\deps\\tc_3rdparty\\vcpkg" -DBUILD_FROM="CI"

      - name: Build all targets
        shell: pwsh
        run: |
          cmake --build build --config Release --target tc_build_all -- /m

      - name: Package (collect files)
        shell: pwsh
        run: |
          cd build/package
          python -V
          python install.py

      - name: Upload artifact (Windows release bundle)
        uses: actions/upload-artifact@v4
        with:
          name: gammaray-windows
          path: |
            build/package/release_*/**
          if-no-files-found: error

  build-android:
    name: Build (Android)
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      # Placeholder packaging step. The Android client build is not part of this repository's CI yet.
      # We still publish an Android artifact bundle to align with expected artifacts.
      - name: Prepare Android artifact bundle
        run: |
          mkdir -p android-package
          echo "GammaRay Android package placeholder. See docs/How_to_use.md for Android client." > android-package/README.txt

      - name: Upload artifact (Android)
        uses: actions/upload-artifact@v4
        with:
          name: gammaray-android
          path: |
            android-package/**
          if-no-files-found: error
