name: Windows Build with QEMU

on:
  push:
    branches: [ main, develop, ci/windows-qemu-vcpkg-build ]
  pull_request:
    branches: [ main, develop ]

env:
  BUILD_TYPE: Release
  VCPKG_VERSION: '2024.01.12'
  QT_VERSION: '6.8.3'
  VCPKG_TARGET_TRIPLET: 'x64-windows'

jobs:
  build-windows:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        submodules: recursive
        
    - name: Set up QEMU
      uses: docker/setup-qemu-action@v3
      with:
        platforms: windows-amd64
        
    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3
      
    - name: Create Windows build environment Dockerfile
      run: |
        cat > Dockerfile.windows << 'EOF'
        # Use Windows Server Core as base image
        FROM mcr.microsoft.com/windows/servercore:ltsc2022
        
        # Set working directory
        WORKDIR C:/build
        
        # Install chocolatey
        RUN powershell -Command \
            Set-ExecutionPolicy Bypass -Scope Process -Force; \
            [System.Net.ServicePointManager]::SecurityProtocol = [System.Net.ServicePointManager]::SecurityProtocol -bor 3072; \
            iex ((New-Object System.Net.WebClient).DownloadString('https://community.chocolatey.org/install.ps1'))
        
        # Install required tools
        RUN choco install -y git --no-progress
        RUN choco install -y cmake --installargs 'ADD_CMAKE_TO_PATH=System' --no-progress
        RUN choco install -y visualstudio2022buildtools --no-progress
        RUN choco install -y visualstudio2022workload-nativedesktop --no-progress
        RUN choco install -y vcpkg --no-progress
        RUN choco install -y qt6 --version=6.8.3 --no-progress
        
        # Set environment variables
        ENV VCPKG_ROOT=C:/vcpkg
        ENV QT_ROOT=C:/Qt/6.8.3/msvc2022_64
        ENV CMAKE_TOOLCHAIN_FILE=C:/vcpkg/scripts/buildsystems/vcpkg.cmake
        
        # Copy source code
        COPY . C:/build/GammaRay
        
        # Change to build directory
        WORKDIR C:/build
        
        CMD ["cmd"]
        EOF
        
    - name: Build Windows Docker image
      run: |
        docker buildx build \
          --platform windows/amd64 \
          --load \
          -f Dockerfile.windows \
          -t gammaray-windows-build \
          .
          
    - name: Create build script
      run: |
        cat > build_windows.ps1 << 'EOF'
        # Set environment variables
        $env:VCPKG_ROOT = "C:/vcpkg"
        $env:QT_ROOT = "C:/Qt/6.8.3/msvc2022_64"
        $env:VK_SDK_ROOT = "C:/VulkanSDK/1.3.290.0"
        $env:CMAKE_TOOLCHAIN_FILE = "C:/vcpkg/scripts/buildsystems/vcpkg.cmake"
        
        # Navigate to project directory
        cd C:/build/GammaRay
        
        # Initialize vcpkg if not already done
        if (!(Test-Path "C:/vcpkg/vcpkg.exe")) {
            cd C:/vcpkg
            ./bootstrap-vcpkg.bat
        }
        
        # Install vcpkg dependencies
        cd C:/vcpkg
        ./vcpkg.exe install gflags:x64-windows
        ./vcpkg.exe install sqlite3:x64-windows
        ./vcpkg.exe install detours:x64-windows
        ./vcpkg.exe install gtest:x64-windows
        ./vcpkg.exe install libvpx:x64-windows
        ./vcpkg.exe install opus:x64-windows
        ./vcpkg.exe install fftw3:x64-windows
        ./vcpkg.exe install easyhook:x64-windows
        ./vcpkg.exe install glm:x64-windows
        ./vcpkg.exe install sdl2:x64-windows
        ./vcpkg.exe install jemalloc:x64-windows
        ./vcpkg.exe install protobuf:x64-windows
        ./vcpkg.exe install asio:x64-windows
        ./vcpkg.exe install openssl:x64-windows
        ./vcpkg.exe install ffmpeg:x64-windows
        ./vcpkg.exe install opencv:x64-windows
        ./vcpkg.exe install cpr:x64-windows
        
        # Go back to project directory
        cd C:/build/GammaRay
        
        # Create build directory
        mkdir build
        cd build
        
        # Configure with CMake
        cmake .. `
          -G "Visual Studio 17 2022" `
          -A x64 `
          -DCMAKE_BUILD_TYPE=Release `
          -DCMAKE_TOOLCHAIN_FILE="C:/vcpkg/scripts/buildsystems/vcpkg.cmake" `
          -DVCPKG_TARGET_TRIPLET=x64-windows `
          -DBUILD_PREMIUM=OFF `
          -DJEMALLOC_ENABLED=ON `
          -DMEMORY_STST_ENABLED=OFF
        
        # Build the project
        cmake --build . --config Release --parallel
        
        # Install the project
        cmake --install . --config Release --prefix C:/build/GammaRay/install
        
        echo "Build completed successfully!"
        EOF
        
    - name: Run Windows build with QEMU
      run: |
        # Copy build script to container
        docker cp build_windows.ps1 gammaray-windows-build:C:/build/build_windows.ps1
        
        # Execute build script
        docker run --platform windows/amd64 \
          -v /tmp/output:/output \
          gammaray-windows-build \
          powershell -ExecutionPolicy Bypass -File C:/build/build_windows.ps1
          
    - name: Alternative approach - Use Windows runner directly
      if: failure()
      uses: actions/checkout@v4
      with:
        submodules: recursive
        
    - name: Set up Windows environment directly
      if: failure()
      uses: microsoft/setup-msbuild@v2
      
    - name: Install vcpkg dependencies (Windows)
      if: failure()
      run: |
        cd deps/tc_3rdparty/vcpkg
        ./bootstrap-vcpkg.bat
        ./vcpkg.exe install gflags:x64-windows
        ./vcpkg.exe install sqlite3:x64-windows
        ./vcpkg.exe install detours:x64-windows
        ./vcpkg.exe install gtest:x64-windows
        ./vcpkg.exe install libvpx:x64-windows
        ./vcpkg.exe install opus:x64-windows
        ./vcpkg.exe install fftw3:x64-windows
        ./vcpkg.exe install easyhook:x64-windows
        ./vcpkg.exe install glm:x64-windows
        ./vcpkg.exe install sdl2:x64-windows
        ./vcpkg.exe install jemalloc:x64-windows
        ./vcpkg.exe install protobuf:x64-windows
        ./vcpkg.exe install asio:x64-windows
        ./vcpkg.exe install openssl:x64-windows
        ./vcpkg.exe install ffmpeg:x64-windows
        ./vcpkg.exe install opencv:x64-windows
        ./vcpkg.exe install cpr:x64-windows
      shell: cmd
      
    - name: Configure CMake (Windows)
      if: failure()
      run: |
        mkdir build
        cd build
        cmake .. ^
          -G "Visual Studio 17 2022" ^
          -A x64 ^
          -DCMAKE_BUILD_TYPE=Release ^
          -DCMAKE_TOOLCHAIN_FILE="%CD%\..\deps\tc_3rdparty\vcpkg\scripts\buildsystems\vcpkg.cmake" ^
          -DVCPKG_TARGET_TRIPLET=x64-windows ^
          -DBUILD_PREMIUM=OFF ^
          -DJEMALLOC_ENABLED=ON ^
          -DMEMORY_STST_ENABLED=OFF
      shell: cmd
      
    - name: Build with MSBuild (Windows)
      if: failure()
      run: |
        cd build
        msbuild GammaRay.sln /p:Configuration=Release /p:Platform=x64 /m
      shell: cmd

  build-cross-platform:
    runs-on: ubuntu-latest
    needs: build-windows
    if: always()
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        submodules: recursive
        
    - name: Install cross-compilation dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          cmake \
          build-essential \
          ninja-build \
          pkg-config \
          qt6-base-dev \
          qt6-tools-dev \
          libqt6websockets6-dev \
          libssl-dev \
          libprotobuf-dev \
          protobuf-compiler \
          libsqlite3-dev \
          libgtest-dev \
          libfftw3-dev \
          libsdl2-dev \
          libopencv-dev \
          libvpx-dev \
          libopus-dev
          
    - name: Create vcpkg environment for cross-compilation
      run: |
        git clone https://github.com/Microsoft/vcpkg.git
        cd vcpkg
        ./bootstrap-vcpkg.sh
        
    - name: Install dependencies with vcpkg
      run: |
        cd vcpkg
        ./vcpkg install gflags:x64-linux
        ./vcpkg install sqlite3:x64-linux
        ./vcpkg install gtest:x64-linux
        ./vcpkg install libvpx:x64-linux
        ./vcpkg install opus:x64-linux
        ./vcpkg install fftw3:x64-linux
        ./vcpkg install glm:x64-linux
        ./vcpkg install sdl2:x64-linux
        ./vcpkg install jemalloc:x64-linux
        ./vcpkg install protobuf:x64-linux
        ./vcpkg install asio:x64-linux
        ./vcpkg install openssl:x64-linux
        ./vcpkg install ffmpeg:x64-linux
        ./vcpkg install opencv:x64-linux
        ./vcpkg install cpr:x64-linux
        
    - name: Configure CMake for Linux build
      run: |
        mkdir build
        cd build
        cmake .. \
          -G "Ninja" \
          -DCMAKE_BUILD_TYPE=Release \
          -DCMAKE_TOOLCHAIN_FILE="../vcpkg/scripts/buildsystems/vcpkg.cmake" \
          -DVCPKG_TARGET_TRIPLET=x64-linux \
          -DBUILD_PREMIUM=OFF \
          -DJEMALLOC_ENABLED=ON \
          -DMEMORY_STST_ENABLED=OFF
          
    - name: Build project
      run: |
        cd build
        cmake --build . --config Release --parallel
        
    - name: Upload build artifacts
      uses: actions/upload-artifact@v4
      with:
        name: gammaray-build-artifacts
        path: |
          build/
          install/
        retention-days: 7